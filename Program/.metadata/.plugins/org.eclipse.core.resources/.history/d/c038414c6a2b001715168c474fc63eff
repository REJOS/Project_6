/*
 * MemorySystem.cpp
 *
 *  Created on: Apr 17, 2017
 *      Author: john
 */

#include <cstdio>
#include <stdlib.h>
#include <cstring>
#include "memorysystem.h"

#define BUFFER_SIZE 256
#define MAX_ADDRESSES 100

const char * IN_FILE = "input.txt";
const char * DISK_FILE = "BACKING_STORE";

int main() {

	const char *delimiters = ", ";
	char buffer[BUFFER_SIZE];
	char *last_addr;
	int logic_addr[MAX_ADDRESSES];
	int i = 0;
	int num_addr;

	FILE * input;
	input = fopen(IN_FILE, "r");

	if (input == NULL) {
		printf("Error: could not read %s", IN_FILE);
		return -1;
	}

	while (fgets(buffer, BUFFER_SIZE, input) != NULL) {

		last_addr = strtok(buffer, delimiters);
		while (last_addr != NULL) {
			logic_addr[i] = atoi(last_addr);
			last_addr = strtok(NULL, delimiters);
			i++;
		}

	}

	num_addr = i;

	fclose(input);

	page_table_t * page_table;
	CreatePageTable(page_table);


	return 0;
}

int CreateTLB(tlb_t *tlb) {
	return 0;
}

int SearchTLB(u_int_t page_num, tlb_t tlb, bool *is_tlb_hit,
		u_int_t *frame_num) {
	return 0;
}

int CreatePageTable(page_table_t *page_table) {

	page_table = malloc(sizeof(page_table_t));

	if (page_table == NULL) {
		return -1;
	}

	int i;
	for (i = 0; i < NUM_PAGES; i++) {
		page_table->list[i] = NULL;
	}
	page_table->num_entries = 0;

	return 0;
}

int SearchPageTable(u_int_t page_num, tlb_t tlb, bool *is_tlb_hit,
		u_int_t *frame_num) {
	return 0;
}
int pageFaultHandler(u_int_t page_num, /*???*/u_int_t *physical_memory,
		page_table_t *page_table, tlb_t *tlb) {

	FILE * disk;
	disk = fopen(DISK_FILE, "rb");
	if (disk == NULL) {
		printf("Error: could not read %s", DISK_FILE);
		return -1;
	}

	fseek(disk, page_num * PAGE_SIZE, SEEK_SET);

	//fread(new_page, 1, 256, disk);

	fclose(disk);

	return 0;
}

u_int_t ParsePageNum(u_int_t logical_addr) {
	return (logical_addr | PAGE_MASK) >> PAGE_SHIFT;
}

u_int_t ParseOffset(u_int_t logical_addr) {
	return (logical_addr | OFFSET_MASK);
}
